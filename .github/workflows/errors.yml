name: reintentar-errores
on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 2-6" # Ma-Sab 1AM

env:
  DOTNET_NOLOGO: true

defaults:
  run:
    shell: pwsh

permissions: 
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest 
    continue-on-error: true
    steps:
      - name: ü§ñ defaults
        uses: devlooped/actions-bot@v1
        with:
          name: ${{ secrets.BOT_NAME }}
          email: ${{ secrets.BOT_EMAIL }}
          gh_token: ${{ secrets.GH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ü§ò checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.GH_TOKEN }}

      - name: ‚öô dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.x

      - name: ‚öô openlaw
        run: dotnet tool update -g dotnet-openlaw --source https://clarius.blob.core.windows.net/nuget/index.json          

      - name: üîÑ reintentar
        continue-on-error: true
        run: |
            new-item "${{ runner.temp }}/openlaw.md" | out-null
            $dirs = gci ./.github/.openlaw -directory
            foreach ($dir in $dirs) {
                write-host "Processing $dir"
                $files = gci $dir.fullname -file
                write-host "Processing $($files.count) files"
                foreach ($file in $files) {
                    try {
                        openlaw syncitem $file.basename --dir $dir.name --changelog ${{ runner.temp }}/openlaw.md --appendlog
                        if ($lastexitcode -eq 0) {
                            remove-item $file.fullname -force
                        }
                    }
                    catch {
                        write-host "Error processing $($file.BaseName): $($_.Exception.Message)" -ForegroundColor Red
                        continue
                    }
                }
            }

      - name: üöÄ pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: sync/errors
          delete-branch: true
          labels: docs
          title: "‚¨ÜÔ∏è Actualizaci√≥n de normas"
          commit-message: "‚¨ÜÔ∏è Actualizaci√≥n de normas previamente con errores"
          token: ${{ env.GH_TOKEN }}
          body-path: ${{ runner.temp }}/openlaw.md