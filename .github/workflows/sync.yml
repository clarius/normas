# Workflow reusable para sincronizar leyes y decretos
name: sync-core
on:
  workflow_call:
    inputs:
      options:
        required: false
        type: string
        default: ''

env:
  DOTNET_NOLOGO: true

defaults:
  run:
    shell: pwsh

permissions: 
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest 
    continue-on-error: true
    steps:
      - name: ü§ñ defaults
        uses: devlooped/actions-bot@v1
        with:
          name: ${{ secrets.BOT_NAME }}
          email: ${{ secrets.BOT_EMAIL }}
          gh_token: ${{ secrets.GH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ü§ò checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.GH_TOKEN }}

      - name: ‚öô dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.x

      - name: ‚öô openlaw
        run: dotnet tool update -g dotnet-openlaw --source https://clarius.blob.core.windows.net/nuget/index.json          

      - name: üîÑ leyes
        run: openlaw sync --dir ./ley --tipo Ley --jurisdiccion Nacional --changelog ${{ runner.temp }}/openlaw.md ${{ inputs.options }} 

      - name: üîÑ decretos
        run: openlaw sync --dir ./decreto --tipo Decreto --jurisdiccion Nacional --changelog ${{ runner.temp }}/openlaw.md --appendlog ${{ inputs.options }}

      - name: ‚è´ timestamps
        continue-on-error: true
        run: |
          get-content ${{ runner.temp }}/openlaw.txt | % { git add $_ || echo "No changes to add for $_" }
          git commit -m "‚è≥ Actualizaci√≥n de timestamps" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

      - name: ‚ùå errors
        run: |
          git add ./.github/.openlaw/ || echo "No errors to add"
          git commit -m "‚ùå Agregar errores de sincronizaci√≥n"|| echo "No errors to commit"
          git push origin main || echo "No errors to push"

      - name: üöÄ pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: openlaw
          delete-branch: true
          labels: docs
          title: "‚¨ÜÔ∏è Actualizaci√≥n de normas"
          commit-message: "‚¨ÜÔ∏è Actualizaci√≥n de normas"
          token: ${{ env.GH_TOKEN }}
          body-path: ${{ runner.temp }}/openlaw.md